# Release - Build and publish release image and Deploy to Cloud Run.
name: Release to dev

on:
  push:
    branches:
    - dev

env:
  REGION: asia-south1
  LOCATION: asia-south1-docker.pkg.dev
  IMAGE: asia-south1-docker.pkg.dev/cloud-run-preview-demo/cloud-run-repo/release
  SERVICE: release
  DEPLOYMENT_URL: ""

jobs:
  build-publish-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Use Node.js 21.2
      uses: actions/setup-node@v3
      with:
        node-version: '21.2'

    - name: Log github context
      run: echo $JSON
      env:
        JSON: ${{ toJSON(github) }}

    - name: Install packages
      run: yarn install --frozen-lockfile

    - name: Dry run Semantic release to get next version
      run: |
        GH_TOKEN=${{secrets.GITHUB_TOKEN}} npx semantic-release --dry-run > dry-run-release.log
        NEXT_RELEASE=$(cat dry-run-release.log | grep -oP "the next release version is \K.*") >> $GITHUB_ENV

    - name: Log next release tag
      run: echo "Next release version is ${{ env.DEPLOYMENT_URL }}"

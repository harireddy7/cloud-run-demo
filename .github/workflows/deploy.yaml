# This workflow build and push a Docker image to Google Artifact Registry and deploy it on Cloud Run when a commit is pushed to the "main" branch

name: Release - Build release image and Deploy to Cloud Run

on:
  push:
    branches:
    - main

env:
  REGION: asia-south1
  LOCATION: asia-south1-docker.pkg.dev
  PROJECT_ID: cloud-run-preview-demo
  REPO: cloud-run-repo
  IMAGE: preview-demo
  SERVICE: preview-demo
  BASE_VERSION: 1.0.0

jobs:
  build-publish-release:
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install google cloud sdk
      uses: 'google-github-actions/setup-gcloud@v2'
      with:
        version: '456.0.0'

    - name: Authenticate to GCP with USER
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GAR_USER_KEYS_JSON }}

    - name: Get docker preview image name
      id: get-docker-image
      run: |
        echo "asia-south1-docker.pkg.dev/cloud-run-preview-demo/cloud-run-repo/preview-demo:1.0.0-23"

    - name: Deploy to Cloud Run
      id: deploy
      run: |
        OUTPUT=gcloud-deploy-output.log
        gcloud run deploy preview-demo \
          --image asia-south1-docker.pkg.dev/cloud-run-preview-demo/cloud-run-repo/preview-demo:1.0.0-23 \
          --service-account cloud-run@user-deploy.iam.gserviceaccount.com \
          --project user-deploy \
          --region asia-south1 \
          --allow-unauthenticated \
          --update-labels managed-by=github-actions \
          --format="flattened(status.url, status.traffic[0].url)" > $OUTPUT
        cat $OUTPUT
